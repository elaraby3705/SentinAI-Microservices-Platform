<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentin-AI | Security Command Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #0f172a; font-family: 'Segoe UI', system-ui, sans-serif; }
        .card { border: 1px solid #1e293b; background-color: #1e293b; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card-header { background-color: #334155; border-bottom: 1px solid #475569; font-weight: 600; }

        /* Terminal Style Logs */
        .terminal-window {
            background-color: #0d1117;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #30363d;
            color: #58a6ff;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #21262d; padding-bottom: 2px; }
        .log-time { color: #8b949e; font-size: 0.85em; margin-right: 10px; }
        .log-level-critical { color: #ff7b72; font-weight: bold; }
        .log-level-info { color: #79c0ff; }

        /* Status Indicators */
        .status-dot {
            height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 5px;
        }
        .status-online { background-color: #2ea043; box-shadow: 0 0 8px #2ea043; }
        .status-offline { background-color: #da3633; box-shadow: 0 0 8px #da3633; }

        /* Camera Placeholder */
        .camera-feed {
            background: #000;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
            border: 2px dashed #333;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="fas fa-shield-alt text-primary me-2"></i>Sentin-AI <span class="badge bg-danger ms-2" style="font-size: 0.6em;">BETA</span>
        </a>
        <div class="d-flex align-items-center">
            <span class="text-muted small me-3"><i class="fas fa-server me-1"></i> Cluster: Local-VM</span>
            <div id="connection-status" class="badge bg-success">Connected</div>
        </div>
    </div>
</nav>

<div class="container-fluid px-4">
    <div class="row g-4">

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header"><i class="fas fa-heartbeat me-2"></i>System Health</div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fab fa-python me-2"></i>Brain Service (Eye)</span>
                        <span id="eye-badge" class="badge bg-secondary">Checking...</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fab fa-node-js me-2"></i>Alert Service (Node)</span>
                        <span id="alert-badge" class="badge bg-secondary">Checking...</span>
                    </div>
                    <hr>
                    <button class="btn btn-outline-light w-100 btn-sm" onclick="checkHealth()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Status
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-gamepad me-2"></i>Simulation Controls</div>
                <div class="card-body text-center">
                    <div class="camera-feed mb-3" id="camera-placeholder">
                        <div class="text-center">
                            <i class="fas fa-video-slash fa-3x mb-2"></i>
                            <p>Camera Feed Offline</p>
                        </div>
                    </div>
                    <button id="scan-btn" class="btn btn-primary w-100" onclick="analyzeImage()">
                        <i class="fas fa-camera me-2"></i>Trigger Security Scan
                    </button>
                    <div id="scan-spinner" class="spinner-border text-primary mt-3 d-none" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-terminal me-2"></i>Live Security Logs</span>
                    <button class="btn btn-xs btn-outline-secondary" onclick="fetchAlerts()"><i class="fas fa-redo"></i></button>
                </div>
                <div class="card-body p-0">
                    <div class="terminal-window" id="alerts-list">
                        <div class="log-entry">
                            <span class="log-time">[SYSTEM]</span> Ready to receive alerts...
                        </div>
                    </div>
                </div>
                <div class="card-footer text-muted small">
                    Last updated: <span id="last-update">Never</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="liveToast" class="toast text-bg-primary" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Notification</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toast-msg">
      Action completed.
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ⚙️ Configuration (Via Nginx Proxy)
    const EYE_API = "/api/eye";
    const ALERT_API = "/api/alert";

    // Toast Utility
    const showToast = (msg, type='primary') => {
        const toastEl = document.getElementById('liveToast');
        document.getElementById('toast-msg').innerText = msg;
        toastEl.className = `toast text-bg-${type}`;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    };

    // 1. Health Check
    async function checkHealth() {
        updateBadge('eye-badge', 'secondary', 'Connecting...');
        updateBadge('alert-badge', 'secondary', 'Connecting...');

        try {
            let res = await fetch(`${EYE_API}/`);
            updateBadge('eye-badge', res.ok ? 'success' : 'danger', res.ok ? 'ONLINE' : 'ERROR');
        } catch (e) { updateBadge('eye-badge', 'danger', 'OFFLINE'); }

        try {
            let res = await fetch(`${ALERT_API}/status`);
            updateBadge('alert-badge', res.ok ? 'success' : 'danger', res.ok ? 'ONLINE' : 'ERROR');
        } catch (e) { updateBadge('alert-badge', 'danger', 'OFFLINE'); }
    }

    function updateBadge(id, color, text) {
        const el = document.getElementById(id);
        el.className = `badge bg-${color}`;
        el.innerText = text;
        if(color === 'success') {
            el.innerHTML = `<span class="status-dot status-online"></span>${text}`;
        }
    }

    // 2. Simulate Analysis
    async function analyzeImage() {
        const btn = document.getElementById('scan-btn');
        const spinner = document.getElementById('scan-spinner');
        const placeholder = document.getElementById('camera-placeholder');

        // Visual Feedback
        btn.disabled = true;
        spinner.classList.remove('d-none');
        placeholder.innerHTML = '<img src="https://picsum.photos/400/250?grayscale" class="img-fluid rounded" alt="Scanned">';

        try {
            let res = await fetch(`${EYE_API}/analyze`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "image_url": "http://cam-01.local/rec.jpg" })
            });
            let data = await res.json();

            showToast(`Scan Complete: ${data.threat_level.toUpperCase()}`, 'danger');
            setTimeout(fetchAlerts, 1000); // Auto refresh logs
        } catch (e) {
            showToast("Connection Failed!", "danger");
        } finally {
            btn.disabled = false;
            spinner.classList.add('d-none');
        }
    }

    // 3. Fetch Alerts
    async function fetchAlerts() {
        try {
            let res = await fetch(`${ALERT_API}/alerts`);
            let alerts = await res.json();
            const list = document.getElementById('alerts-list');

            if(alerts.length === 0) {
                 list.innerHTML = '<div class="log-entry">No alerts found in system.</div>';
                 return;
            }

            list.innerHTML = ""; // Clear
            // Reverse to show newest first
            [...alerts].reverse().forEach(alert => {
                const isCrit = alert.level === 'critical';
                const colorClass = isCrit ? 'log-level-critical' : 'log-level-info';
                const icon = isCrit ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-info-circle"></i>';

                const html = `
                <div class="log-entry">
                    <span class="log-time">[${new Date(alert.timestamp).toLocaleTimeString()}]</span>
                    <span class="${colorClass}">${icon} ${alert.level.toUpperCase()}:</span>
                    ${alert.message}
                </div>`;
                list.innerHTML += html;
            });

            document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
        } catch (e) {
            console.error("Failed to fetch alerts");
        }
    }

    // Initial Load
    checkHealth();
    fetchAlerts();
</script>

</body>
</html>